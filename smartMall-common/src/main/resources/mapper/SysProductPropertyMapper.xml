<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.smartMall.mapper.SysProductPropertyMapper">

    <resultMap id="BaseResultMap" type="com.smartMall.entities.domain.SysProductProperty">
            <id property="propertyId" column="property_id" jdbcType="VARCHAR"/>
            <result property="propertyName" column="property_name" jdbcType="VARCHAR"/>
            <result property="pCategoryId" column="p_category_id" jdbcType="VARCHAR"/>
            <result property="categoryId" column="category_id" jdbcType="VARCHAR"/>
            <result property="propertySort" column="property_sort" jdbcType="INTEGER"/>
            <result property="coverType" column="cover_type" jdbcType="TINYINT"/>
    </resultMap>

    <resultMap id="VOResultMap" type="com.smartMall.entities.vo.SysProductPropertyVO">
            <id property="propertyId" column="property_id" jdbcType="VARCHAR"/>
            <result property="propertyName" column="property_name" jdbcType="VARCHAR"/>
            <result property="pCategoryId" column="p_category_id" jdbcType="VARCHAR"/>
            <result property="categoryId" column="category_id" jdbcType="VARCHAR"/>
            <result property="propertySort" column="property_sort" jdbcType="INTEGER"/>
            <result property="coverType" column="cover_type" jdbcType="TINYINT"/>
            <result property="pCategoryName" column="p_category_name" jdbcType="VARCHAR"/>
            <result property="categoryName" column="category_name" jdbcType="VARCHAR"/>
    </resultMap>

    <sql id="Base_Column_List">
        property_id,property_name,p_category_id,
        category_id,property_sort,cover_type
    </sql>

    <!-- 联表查询：根据二级分类ID查询属性列表，带分类名称 -->
    <select id="selectByCategoryId" resultMap="VOResultMap">
        SELECT
            p.property_id,
            p.property_name,
            p.p_category_id,
            p.category_id,
            p.property_sort,
            p.cover_type,
            pc.category_name AS p_category_name,
            c.category_name AS category_name
        FROM sys_product_property p
        LEFT JOIN sys_category pc ON p.p_category_id = pc.category_id
        LEFT JOIN sys_category c ON p.category_id = c.category_id
        WHERE p.category_id = #{categoryId}
        ORDER BY p.property_sort ASC
    </select>

    <!-- 联表查询：根据属性ID获取属性详情，带分类名称 -->
    <select id="selectVOById" resultMap="VOResultMap">
        SELECT
            p.property_id,
            p.property_name,
            p.p_category_id,
            p.category_id,
            p.property_sort,
            p.cover_type,
            pc.category_name AS p_category_name,
            c.category_name AS category_name
        FROM sys_product_property p
        LEFT JOIN sys_category pc ON p.p_category_id = pc.category_id
        LEFT JOIN sys_category c ON p.category_id = c.category_id
        WHERE p.property_id = #{propertyId}
    </select>

    <!-- 获取指定分类下的最大排序值 -->
    <select id="getMaxSortByCategoryId" resultType="java.lang.Integer">
        SELECT IFNULL(MAX(property_sort), 0)
        FROM sys_product_property
        WHERE category_id = #{categoryId}
    </select>

</mapper>
